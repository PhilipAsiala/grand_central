{"AWSTemplateFormatVersion":"2010-09-09","Description":"Template for AWS data ingest into Splunk using AWS Kinesis Firehose and AWS Lambda.","Mappings":{"BucketMap":{"us-east-1":{"BucketName":"trumpet-splunk-prod-us-east-1"},"us-east-2":{"BucketName":"trumpet-splunk-prod-us-east-2"},"us-west-1":{"BucketName":"trumpet-splunk-prod-us-west-1"},"us-west-2":{"BucketName":"trumpet-splunk-prod-us-west-2"},"ca-central-1":{"BucketName":"trumpet-splunk-prod-ca-central-1"},"eu-central-1":{"BucketName":"trumpet-splunk-prod-eu-central-1"},"eu-west-1":{"BucketName":"trumpet-splunk-prod-eu-west-1"},"eu-west-2":{"BucketName":"trumpet-splunk-prod-eu-west-2"},"eu-west-3":{"BucketName":"trumpet-splunk-prod-eu-west-3"},"ap-northeast-1":{"BucketName":"trumpet-splunk-prod-ap-northeast-1"},"ap-northeast-2":{"BucketName":"trumpet-splunk-prod-ap-northeast-2"},"ap-southeast-1":{"BucketName":"trumpet-splunk-prod-ap-southeast-1"},"ap-southeast-2":{"BucketName":"trumpet-splunk-prod-ap-southeast-2"},"ap-south-1":{"BucketName":"trumpet-splunk-prod-ap-south-1"},"sa-east-1":{"BucketName":"trumpet-splunk-prod-sa-east-1"}}},"Resources":{"CloudTrailEventRule":{"Type":"AWS::Events::Rule","Properties":{"EventPattern":{"detail-type":["AWS API Call via CloudTrail","AWS Console Sign In via CloudTrail"]},"State":"ENABLED","Targets":[{"RoleArn":{"Fn::GetAtt":["CWEFirehoseDeliveryRole","Arn"]},"Id":"splunk_cloudtrail_firehose_target","Arn":{"Fn::GetAtt":["CWEFirehoseDeliveryStream","Arn"]}}]}},"CWEFirehoseProcessor":{"Type":"AWS::Lambda::Function","Properties":{"Code":{"S3Bucket":{"Fn::FindInMap":["BucketMap",{"Ref":"AWS::Region"},"BucketName"]},"S3Key":"splunk_cwe_firehose_processor_v0.2.zip"},"Description":"Stream events from CloudWatch Events to Splunk using HTTP event collector","MemorySize":512,"Handler":"lambda_function.handler","Role":{"Fn::GetAtt":["CWEFirehoseProcessorRole","Arn"]},"Timeout":300,"Runtime":"python2.7"}},"CWEFirehoseDeliveryStream":{"Type":"AWS::KinesisFirehose::DeliveryStream","Properties":{"SplunkDestinationConfiguration":{"S3Configuration":{"CompressionFormat":"UNCOMPRESSED","BucketARN":{"Fn::GetAtt":["CWEBackupS3Bucket","Arn"]},"RoleARN":{"Fn::GetAtt":["CWEBackupS3Role","Arn"]},"BufferingHints":{"IntervalInSeconds":300,"SizeInMBs":1}},"HECEndpointType":"Event","HECToken":"placeholder","HECAcknowledgmentTimeoutInSeconds":180,"RetryOptions":{"DurationInSeconds":300},"HECEndpoint":"placeholder","S3BackupMode":"FailedEventsOnly","ProcessingConfiguration":{"Enabled":true,"Processors":[{"Parameters":[{"ParameterName":"LambdaArn","ParameterValue":{"Fn::GetAtt":["CWEFirehoseProcessor","Arn"]}},{"ParameterName":"RoleArn","ParameterValue":{"Fn::GetAtt":["CWEBackupS3Role","Arn"]}}],"Type":"Lambda"}]}},"DeliveryStreamType":"DirectPut"}},"CWEFirehoseDeliveryRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"sts:AssumeRole","Sid":"","Effect":"Allow","Principal":{"Service":"events.amazonaws.com"}}]}}},"CWEFirehoseDeliveryPolicy":{"Type":"AWS::IAM::Policy","Properties":{"PolicyName":"firehose_delivery_policy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":["firehose:PutRecord","firehose:PutRecordBatch"],"Resource":[{"Fn::GetAtt":["CWEFirehoseDeliveryStream","Arn"]}],"Effect":"Allow"}]},"Roles":[{"Ref":"CWEFirehoseDeliveryRole"}]}},"CWEBackupS3Bucket":{"Type":"AWS::S3::Bucket","Properties":{"VersioningConfiguration":{"Status":"Enabled"}}},"CWEBackupS3Role":{"Type":"AWS::IAM::Role","Properties":{"Path":"/","Policies":[{"PolicyName":"CWEBackupS3Role","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Sid":"","Effect":"Allow","Action":["glue:GetTableVersions"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["s3:AbortMultipartUpload","s3:GetBucketLocation","s3:GetObject","s3:ListBucket","s3:ListBucketMultipartUploads","s3:PutObject"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["lambda:InvokeFunction","lambda:GetFunctionConfiguration"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],"Resource":"*"},{"Sid":"","Effect":"Allow","Action":["kinesis:DescribeStream","kinesis:GetShardIterator","kinesis:GetRecords"],"Resource":"arn:aws:kinesis:us-west-2:112543817624:stream/%FIREHOSE_STREAM_NAME%"},{"Sid":"","Effect":"Allow","Action":["kms:Decrypt"],"Resource":["arn:aws:kms:region:accountid:key/%SSE_KEY_ARN%"],"Condition":{"StringEquals":{"kms:ViaService":"kinesis.%REGION_NAME%.amazonaws.com"},"StringLike":{"kms:EncryptionContext:aws:kinesis:arn":"arn:aws:kinesis:%REGION_NAME%:112543817624:stream/%FIREHOSE_STREAM_NAME%"}}}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"sts:AssumeRole","Sid":"","Effect":"Allow","Principal":{"Service":"firehose.amazonaws.com"}}]}}},"CWEFirehoseProcessorRole":{"Type":"AWS::IAM::Role","Properties":{"Path":"/","ManagedPolicyArns":["arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"],"Policies":[{"PolicyName":"CWEFirehoseProcessorPolicy","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["lambda:InvokeFunction"],"Resource":["*"]},{"Effect":"Allow","Action":["kinesis:GetRecords","kinesis:GetShardIterator","kinesis:DescribeStream","kinesis:ListStreams","logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],"Resource":"*"}]}}],"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":["sts:AssumeRole"],"Effect":"Allow","Principal":{"Service":["lambda.amazonaws.com"]}}]}}}}}